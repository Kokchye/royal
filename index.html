<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Royal - Gest√£o</title>
    <style>
        :root { --white: #ffffff; --bg: #000000; --card: #1c1c1e; --text: #ffffff; --blue: #0a84ff; --green: #30d158; --red: #ff453a; --border: #2c2c2e; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding: 20px 15px 40px;
            -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent;
        }

        @keyframes modalUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .logo-container { width: 70px; height: 70px; margin: 0 auto 15px; border-radius: 50%; border: 1px solid var(--white); overflow: hidden; box-shadow: 0 0 15px rgba(255,255,255,0.1); }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }

        .tabs { display: flex; background: #1c1c1e; padding: 4px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; border: none; color: #8e8e93; background: transparent; transition: 0.3s; }
        .tab.active-blue { background: #2c2c2e; color: var(--blue); }
        .tab.active-green { background: #2c2c2e; color: var(--green); }

        .card { background: var(--card); padding: 16px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 15px; }
        
        input, select { 
            background: #2c2c2e; border: 1px solid #3a3a3c; color: white; padding: 14px; border-radius: 12px; 
            width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; outline: none;
        }

        .comanda-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 18px; background: #1c1c1e; margin-bottom: 12px; border-radius: 16px; 
            border: 1px solid var(--border); animation: fadeIn 0.3s ease;
        }
        .comanda-item:active { transform: scale(0.98); background: #2c2c2e; }

        .modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); z-index: 100; 
        }
        .modal-content {
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: #1c1c1e; border-radius: 25px 25px 0 0; 
            padding: 25px; padding-bottom: env(safe-area-inset-bottom);
            animation: modalUp 0.4s cubic-bezier(0.15, 1, 0.3, 1);
            max-height: 92vh; overflow-y: auto;
        }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--white); color: #000; }
        .btn-pay { background: var(--green); color: white; }
        .btn-wa { background: #25d366; color: white; margin-top: 20px; }
        
        .linha-produto { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .qtd-box { display: flex; align-items: center; background: #2c2c2e; border-radius: 12px; padding: 4px 10px; border: 1px solid #3a3a3c; }
        .btn-mini { background: none; border: none; color: var(--blue); font-size: 24px; padding: 0 10px; cursor: pointer; }

        .total-display { font-size: 42px; font-weight: 800; text-align: center; margin: 25px 0; color: var(--white); letter-spacing: -1px; }
        .info-label { font-size: 11px; color: #8e8e93; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 1px; display: block; font-weight: 700; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center;">
        <div class="logo-container">
            <img src="https://i.imgur.com/f2q9QgG.jpeg" alt="Logo">
        </div>
        <h2 style="font-weight: 800; font-size: 22px; margin: 0 0 5px;">Royal</h2>
        <p style="color: #8e8e93; font-size: 12px; margin: 0 0 25px; letter-spacing: 2px;">SISTEMA DE GEST√ÉO</p>
    </div>

    <div class="tabs">
        <button id="tabAbertos" class="tab active-blue" onclick="mudarAba('aberto')">EM ABERTO</button>
        <button id="tabPagos" class="tab" onclick="mudarAba('pago')">HIST√ìRICO</button>
    </div>

    <div id="areaNovo">
        <input type="text" id="novoCliente" placeholder="Nome do Cliente ou Mesa" autocomplete="off">
        <button class="btn btn-primary" onclick="novaFicha()">+ ABRIR NOVA FICHA</button>
    </div>

    <div id="listaComandas"></div>
    
    <div id="btnZerar" style="display:none; text-align:center; margin-top: 20px;">
        <button onclick="limparTudo()" style="background:none; border:none; color:var(--red); font-size:12px; text-decoration:underline;">Zerar todo o hist√≥rico</button>
    </div>
</div>

<div id="modalFicha" class="modal">
    <div class="modal-content">
        <div style="width: 45px; height: 5px; background: #3a3a3c; margin: 0 auto 25px; border-radius: 10px;"></div>
        
        <h2 id="viewNome" style="text-align: center; margin: 0; font-size: 26px; font-weight: 800;"></h2>
        <p id="viewHoraAbertura" style="text-align: center; font-size: 14px; color: #8e8e93; margin: 8px 0 25px;"></p>
        
        <span class="info-label">Consumo de Rosh</span>
        <div class="card" style="background: #2c2c2e; margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600;">üí® Rosh (R$ 15,00)</span>
                <div class="qtd-box">
                    <button class="btn-mini" onclick="alterarRosh(-1)">-</button>
                    <span id="qtdRosh" style="width:30px; text-align:center; font-weight: 800; font-size: 18px;">0</span>
                    <button class="btn-mini" onclick="alterarRosh(1)">+</button>
                </div>
            </div>
        </div>

        <span class="info-label">Outros Itens</span>
        <div id="containerItens"></div>
        <button class="btn" style="background: #2c2c2e; color: var(--blue); font-size: 14px; border: 1px dashed var(--blue);" onclick="adicionarLinhaProduto()">+ ADICIONAR PRODUTO</button>

        <div class="total-display" id="totalGeral">R$ 0,00</div>

        <div id="botoesAberto">
            <span class="info-label">Meio de Pagamento</span>
            <select id="formaPagamento">
                <option value="Pix">Pix</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Cart√£o">Cart√£o</option>
            </select>
            <button class="btn btn-primary" onclick="salvarDados()">SALVAR ALTERA√á√ïES</button>
            <button class="btn btn-pay" onclick="confirmarPagamento()">CONCLUIR E PAGAR</button>
        </div>
        
        <div id="infoPago" style="display:none; text-align: center; padding: 20px; border: 2px solid var(--green); border-radius: 18px; margin-bottom: 15px; background: rgba(48, 209, 88, 0.1);">
            <span style="color: var(--green); font-weight: 800; font-size: 20px;">PAGO VIA <span id="viewMeioPagamento"></span></span>
        </div>

        <button class="btn btn-wa" id="btnWhats" onclick="compartilharZap()">ENVIAR COMPROVANTE (WHATSAPP)</button>
        <button class="btn" style="background: transparent; color: #8e8e93; margin-top: 15px;" onclick="fecharModal()">VOLTAR</button>
        <button class="btn" style="color: var(--red); font-size: 12px; margin-top: 40px; background:none;" onclick="excluirFicha()">EXCLUIR ESTE REGISTRO</button>
    </div>
</div>

<script>
    let comandas = JSON.parse(localStorage.getItem('tabacaria_final_v1')) || [];
    let abaAtual = 'aberto';
    let indexAtivo = null;

    function novaFicha() {
        const nome = document.getElementById('novoCliente').value;
        if(!nome) return;
        const agora = new Date();
        const hora = agora.getHours().toString().padStart(2, '0') + ':' + agora.getMinutes().toString().padStart(2, '0');
        
        comandas.unshift({ 
            nome: nome, roshs: 0, produtos: [], status: 'aberto', total: 0, 
            abertura: hora, metodo: '' 
        });
        document.getElementById('novoCliente').value = '';
        salvarEAtualizar();
    }

    function mudarAba(status) {
        abaAtual = status;
        document.getElementById('tabAbertos').className = status === 'aberto' ? 'tab active-blue' : 'tab';
        document.getElementById('tabPagos').className = status === 'pago' ? 'tab active-green' : 'tab';
        document.getElementById('areaNovo').style.display = status === 'aberto' ? 'block' : 'none';
        document.getElementById('btnZerar').style.display = status === 'pago' ? 'block' : 'none';
        renderLista();
    }

    function abrirFicha(index) {
        indexAtivo = index;
        const c = comandas[index];
        document.getElementById('viewNome').innerText = c.nome;
        document.getElementById('viewHoraAbertura').innerText = "Iniciada √†s " + c.abertura;
        document.getElementById('qtdRosh').innerText = c.roshs;
        document.getElementById('containerItens').innerHTML = '';
        c.produtos.forEach(p => adicionarLinhaProduto(p.qtd, p.nome, p.preco));
        
        const isAberto = c.status === 'aberto';
        document.getElementById('botoesAberto').style.display = isAberto ? 'block' : 'none';
        document.getElementById('infoPago').style.display = isAberto ? 'none' : 'block';
        document.getElementById('btnWhats').style.display = isAberto ? 'none' : 'block';
        
        if(!isAberto) document.getElementById('viewMeioPagamento').innerText = c.metodo.toUpperCase();
        
        document.getElementById('modalFicha').style.display = 'block';
        calcularTotal();
    }

    function adicionarLinhaProduto(qtd = 1, nome = '', preco = '') {
        const div = document.createElement('div');
        div.className = 'linha-produto';
        div.innerHTML = `
            <div class="qtd-box">
                <button class="btn-mini" onclick="modQtd(this,-1)">-</button>
                <span class="num-qtd" style="width:25px; text-align:center; font-weight:700">${qtd}</span>
                <button class="btn-mini" onclick="modQtd(this,1)">+</button>
            </div>
            <input type="text" placeholder="Item" value="${nome}" style="flex:2; margin:0">
            <input type="number" placeholder="R$" value="${preco}" style="width:85px; margin:0">
        `;
        document.getElementById('containerItens').appendChild(div);
        div.querySelectorAll('input').forEach(i => i.addEventListener('input', calcularTotal));
    }

    function modQtd(btn, val) {
        const span = btn.parentElement.querySelector('.num-qtd');
        span.innerText = Math.max(0, parseInt(span.innerText) + val);
        calcularTotal();
    }

    function alterarRosh(val) {
        const s = document.getElementById('qtdRosh');
        s.innerText = Math.max(0, parseInt(s.innerText) + val);
        calcularTotal();
    }

    function calcularTotal() {
        let t = parseInt(document.getElementById('qtdRosh').innerText) * 15;
        document.querySelectorAll('.linha-produto').forEach(l => {
            const inputs = l.querySelectorAll('input');
            t += parseInt(l.querySelector('.num-qtd').innerText) * (parseFloat(inputs[1].value) || 0);
        });
        document.getElementById('totalGeral').innerText = `R$ ${t.toFixed(2).replace('.', ',')}`;
        return t;
    }

    function salvarDados() {
        const c = comandas[indexAtivo];
        c.roshs = parseInt(document.getElementById('qtdRosh').innerText);
        c.total = calcularTotal();
        c.produtos = [];
        document.querySelectorAll('.linha-produto').forEach(l => {
            const inputs = l.querySelectorAll('input');
            if(inputs[0].value) c.produtos.push({qtd: parseInt(l.querySelector('.num-qtd').innerText), nome: inputs[0].value, preco: parseFloat(inputs[1].value) || 0});
        });
        salvarEAtualizar();
        if(abaAtual === 'aberto') fecharModal();
    }

    function confirmarPagamento() {
        const metodo = document.getElementById('formaPagamento').value;
        if(confirm(`Finalizar conta no ${metodo}?`)) {
            comandas[indexAtivo].status = 'pago';
            comandas[indexAtivo].metodo = metodo;
            salvarDados();
            mudarAba('pago');
        }
    }

    function compartilharZap() {
        const c = comandas[indexAtivo];
        let msg = `*RESUMO DA CONTA*%0A---------------------------%0A`;
        msg += `*Cliente:* ${c.nome}%0A`;
        if(c.roshs > 0) msg += ` ${c.roshs}x Rosh: R$ ${c.roshs * 15},00%0A`;
        c.produtos.forEach(p => {
            msg += `‚Ä¢ ${p.qtd}x ${p.nome}: R$ ${(p.qtd * p.preco).toFixed(2)}%0A`;
        });
        msg += `---------------------------%0A*TOTAL: R$ ${c.total.toFixed(2)}*%0A`;
        msg += `Pagamento: ${c.metodo}`;
        window.open(`https://wa.me/?text=${msg}`);
    }

    function limparTudo() {
        if(confirm("Isso apagar√° todo o hist√≥rico de pagos. Continuar?")) {
            comandas = comandas.filter(c => c.status === 'aberto');
            salvarEAtualizar();
        }
    }

    function excluirFicha() {
        if(confirm("Remover permanentemente?")) {
            comandas.splice(indexAtivo, 1);
            salvarEAtualizar();
            fecharModal();
        }
    }

    function salvarEAtualizar() {
        localStorage.setItem('tabacaria_final_v1', JSON.stringify(comandas));
        renderLista();
    }

    function renderLista() {
        const lista = document.getElementById('listaComandas');
        lista.innerHTML = '';
        const filtradas = comandas.filter(c => c.status === abaAtual);
        
        filtradas.forEach((c) => {
            const realIndex = comandas.indexOf(c);
            lista.innerHTML += `
                <div class="comanda-item" onclick="abrirFicha(${realIndex})">
                    <div>
                        <div style="font-weight:800; font-size:18px; letter-spacing:-0.5px">${c.nome}</div>
                        <div style="color:#8e8e93; font-size:12px; margin-top:2px">${c.status === 'aberto' ? 'In√≠cio: ' + c.abertura : 'Pago via ' + c.metodo}</div>
                    </div>
                    <div style="font-weight:800; font-size:18px; color:${c.status === 'aberto' ? 'var(--blue)' : 'var(--green)'}">
                        R$ ${c.total.toFixed(2)}
                    </div>
                </div>`;
        });
    }

    function fecharModal() { document.getElementById('modalFicha').style.display = 'none'; }
    renderLista();
</script>
</body>
</html>