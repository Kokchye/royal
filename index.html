<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tabacaria">
    <title>Royal</title>
    <style>
        :root { --white: #ffffff; --bg: #000000; --card: #1c1c1e; --text: #ffffff; --blue: #0a84ff; --green: #30d158; --red: #ff453a; --border: #2c2c2e; }
        
        * { 
            /* Desativa o zoom de duplo clique e melhora a resposta ao toque */
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding: 20px 15px 100px;
            overflow-x: hidden;
        }

        /* Banner de InstalaÃ§Ã£o (InstruÃ§Ã£o iOS) */
        #ios-prompt {
            display: none; position: fixed; bottom: 20px; left: 15px; right: 15px;
            background: rgba(44, 44, 46, 0.95); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 15px; z-index: 999; border: 1px solid #3a3a3c;
            animation: fadeIn 0.5s ease;
        }

        .logo-container { width: 70px; height: 70px; margin: 0 auto 15px; border-radius: 50%; border: 1px solid var(--white); overflow: hidden; }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }

        .tabs { display: flex; background: #1c1c1e; padding: 4px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; border: none; color: #8e8e93; background: transparent; }
        .tab.active-blue { background: #2c2c2e; color: var(--blue); }
        .tab.active-green { background: #2c2c2e; color: var(--green); }

        .card { background: var(--card); padding: 16px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 15px; }
        
        input, select { 
            background: #2c2c2e; border: 1px solid #3a3a3c; color: white; padding: 14px; border-radius: 12px; 
            width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; outline: none;
        }

        .comanda-item { display: flex; justify-content: space-between; align-items: center; padding: 18px; background: #1c1c1e; margin-bottom: 12px; border-radius: 16px; border: 1px solid var(--border); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); z-index: 100; }
        .modal-content {
            position: absolute; bottom: 0; left: 0; right: 0; background: #1c1c1e; border-radius: 25px 25px 0 0; 
            padding: 25px; padding-bottom: env(safe-area-inset-bottom);
            max-height: 92vh; overflow-y: auto;
        }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--white); color: #000; }
        .btn-pay { background: var(--green); color: white; }
        .btn-wa { background: #25d366; color: white; margin-top: 20px; }
        
        .qtd-box { display: flex; align-items: center; background: #2c2c2e; border-radius: 12px; padding: 4px 10px; border: 1px solid #3a3a3c; }
        .btn-mini { background: none; border: none; color: var(--blue); font-size: 24px; padding: 0 10px; }

        .total-display { font-size: 42px; font-weight: 800; text-align: center; margin: 25px 0; color: var(--white); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="ios-prompt">
    <div style="display:flex; align-items:center; gap:12px;">
        <div style="font-size:30px;">ðŸ“²</div>
        <div style="font-size:13px; color:white;">
            Para salvar como APP: clique em <img src="https://img.icons8.com/ios/50/ffffff/share-rounded.png" width="16" style="vertical-align:middle"> <b>Compartilhar</b> e depois em <b>Adicionar Ã  Tela de InÃ­cio</b>.
        </div>
        <button onclick="document.getElementById('ios-prompt').style.display='none'" style="background:none; border:none; color:var(--blue); font-weight:bold;">OK</button>
    </div>
</div>

<div class="container">
    <div style="text-align:center;">
        <div class="logo-container"><img src="https://i.imgur.com/f2q9QgG.jpeg"></div>
        <h2 style="margin: 0;">Royal</h2>
    </div>

    <div class="tabs" style="margin-top:20px">
        <button id="tabAbertos" class="tab active-blue" onclick="mudarAba('aberto')">ABERTAS</button>
        <button id="tabPagos" class="tab" onclick="mudarAba('pago')">HISTÃ“RICO</button>
    </div>

    <div id="areaNovo">
        <input type="text" id="novoCliente" placeholder="Nome do Cliente / Mesa" autocomplete="off">
        <button class="btn btn-primary" onclick="novaFicha()">+ ABRIR COMANDA</button>
    </div>

    <div id="listaComandas"></div>
</div>

<div id="modalFicha" class="modal">
    <div class="modal-content">
        <div style="width: 45px; height: 5px; background: #3a3a3c; margin: 0 auto 20px; border-radius: 10px;"></div>
        <h2 id="viewNome" style="text-align: center; margin: 0;"></h2>
        <p id="viewHoraAbertura" style="text-align: center; color: #8e8e93; font-size: 14px;"></p>
        
        <div class="card" style="background: #2c2c2e; display:flex; justify-content:space-between; align-items:center;">
            <span>ðŸ’¨ Rosh (R$ 15,00)</span>
            <div class="qtd-box">
                <button class="btn-mini" onclick="alterarRosh(-1)">-</button>
                <span id="qtdRosh" style="width:30px; text-align:center; font-weight:800;">0</span>
                <button class="btn-mini" onclick="alterarRosh(1)">+</button>
            </div>
        </div>

        <div id="containerItens"></div>
        <button class="btn" style="background:#2c2c2e; color:var(--blue); border:1px dashed var(--blue);" onclick="adicionarLinhaProduto()">+ ADICIONAR ITEM</button>

        <div class="total-display" id="totalGeral">R$ 0,00</div>

        <div id="botoesAberto">
            <select id="formaPagamento">
                <option value="Pix">Pix</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="CartÃ£o">CartÃ£o</option>
            </select>
            <button class="btn btn-primary" onclick="salvarDados()">SALVAR</button>
            <button class="btn btn-pay" onclick="confirmarPagamento()">FECHAR E PAGAR</button>
        </div>

        <div id="infoPago" style="display:none; text-align:center; padding:15px; border:2px solid var(--green); border-radius:15px; color:var(--green); font-weight:bold;">
            PAGO NO <span id="viewMeioPagamento"></span>
        </div>

        <button class="btn btn-wa" id="btnWhats" onclick="compartilharZap()">ENVIAR WHATSAPP</button>
        <button class="btn" style="background:transparent; color:#8e8e93;" onclick="fecharModal()">VOLTAR</button>
        <button class="btn" style="color:var(--red); font-size:12px; margin-top:30px; background:none;" onclick="excluirFicha()">EXCLUIR REGISTRO</button>
    </div>
</div>

<script>
    let comandas = JSON.parse(localStorage.getItem('tabacaria_v10')) || [];
    let abaAtual = 'aberto';
    let indexAtivo = null;

    // Detectar iPhone para mostrar o aviso de "Salvar na Tela Inicial"
    const isIos = () => {
        const userAgent = window.navigator.userAgent.toLowerCase();
        return /iphone|ipad|ipod/.test(userAgent);
    };
    const inStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

    if (isIos() && !inStandaloneMode()) {
        document.getElementById('ios-prompt').style.display = 'block';
    }

    function novaFicha() {
        const nome = document.getElementById('novoCliente').value;
        if(!nome) return;
        const hora = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        comandas.unshift({ nome, roshs: 0, produtos: [], status: 'aberto', total: 0, abertura: hora, metodo: '' });
        document.getElementById('novoCliente').value = '';
        salvarEAtualizar();
    }

    function mudarAba(status) {
        abaAtual = status;
        document.getElementById('tabAbertos').className = status === 'aberto' ? 'tab active-blue' : 'tab';
        document.getElementById('tabPagos').className = status === 'pago' ? 'tab active-green' : 'tab';
        document.getElementById('areaNovo').style.display = status === 'aberto' ? 'block' : 'none';
        renderLista();
    }

    function abrirFicha(index) {
        indexAtivo = index;
        const c = comandas[index];
        document.getElementById('viewNome').innerText = c.nome;
        document.getElementById('viewHoraAbertura').innerText = "Iniciada Ã s " + c.abertura;
        document.getElementById('qtdRosh').innerText = c.roshs;
        document.getElementById('containerItens').innerHTML = '';
        c.produtos.forEach(p => adicionarLinhaProduto(p.qtd, p.nome, p.preco));
        
        const isAberto = c.status === 'aberto';
        document.getElementById('botoesAberto').style.display = isAberto ? 'block' : 'none';
        document.getElementById('infoPago').style.display = isAberto ? 'none' : 'block';
        document.getElementById('btnWhats').style.display = isAberto ? 'none' : 'block';
        if(!isAberto) document.getElementById('viewMeioPagamento').innerText = c.metodo.toUpperCase();
        
        document.getElementById('modalFicha').style.display = 'block';
        calcularTotal();
    }

    function adicionarLinhaProduto(qtd = 1, nome = '', preco = '') {
        const div = document.createElement('div');
        div.className = 'linha-produto';
        div.style.display = "flex"; div.style.gap = "8px"; div.style.marginBottom = "10px";
        div.innerHTML = `
            <div class="qtd-box"><button class="btn-mini" onclick="modQtd(this,-1)">-</button><span class="num-qtd" style="width:20px;text-align:center">${qtd}</span><button class="btn-mini" onclick="modQtd(this,1)">+</button></div>
            <input type="text" placeholder="Item" value="${nome}" style="flex:2; margin:0">
            <input type="number" placeholder="R$" value="${preco}" style="width:80px; margin:0">
        `;
        document.getElementById('containerItens').appendChild(div);
        div.querySelectorAll('input').forEach(i => i.addEventListener('input', calcularTotal));
    }

    function modQtd(btn, val) {
        const span = btn.parentElement.querySelector('.num-qtd');
        span.innerText = Math.max(0, parseInt(span.innerText) + val);
        calcularTotal();
    }

    function alterarRosh(val) {
        const s = document.getElementById('qtdRosh');
        s.innerText = Math.max(0, parseInt(s.innerText) + val);
        calcularTotal();
    }

    function calcularTotal() {
        let t = parseInt(document.getElementById('qtdRosh').innerText) * 15;
        document.querySelectorAll('.linha-produto').forEach(l => {
            const inputs = l.querySelectorAll('input');
            t += parseInt(l.querySelector('.num-qtd').innerText) * (parseFloat(inputs[1].value) || 0);
        });
        document.getElementById('totalGeral').innerText = `R$ ${t.toFixed(2).replace('.', ',')}`;
        return t;
    }

    function salvarDados() {
        const c = comandas[indexAtivo];
        c.roshs = parseInt(document.getElementById('qtdRosh').innerText);
        c.total = calcularTotal();
        c.produtos = [];
        document.querySelectorAll('.linha-produto').forEach(l => {
            const inputs = l.querySelectorAll('input');
            if(inputs[0].value) c.produtos.push({qtd: parseInt(l.querySelector('.num-qtd').innerText), nome: inputs[0].value, preco: parseFloat(inputs[1].value) || 0});
        });
        salvarEAtualizar();
        fecharModal();
    }

    function confirmarPagamento() {
        const metodo = document.getElementById('formaPagamento').value;
        if(confirm(`Fechar no ${metodo}?`)) {
            comandas[indexAtivo].status = 'pago';
            comandas[indexAtivo].metodo = metodo;
            salvarDados();
            mudarAba('pago');
        }
    }

    function compartilharZap() {
        const c = comandas[indexAtivo];
        let msg = `*Royal*%0A*Cliente:* ${c.nome}%0A`;
        if(c.roshs > 0) msg += `â€¢ ${c.roshs}x Rosh: R$ ${c.roshs * 15}%0A`;
        c.produtos.forEach(p => msg += `â€¢ ${p.qtd}x ${p.nome}: R$ ${p.qtd * p.preco}%0A`);
        msg += `%0A*TOTAL: R$ ${c.total.toFixed(2)}*`;
        window.open(`https://wa.me/?text=${msg}`);
    }

    function excluirFicha() {
        if(confirm("Remover?")) {
            comandas.splice(indexAtivo, 1);
            salvarEAtualizar();
            fecharModal();
        }
    }

    function salvarEAtualizar() {
        localStorage.setItem('tabacaria_v10', JSON.stringify(comandas));
        renderLista();
    }

    function renderLista() {
        const lista = document.getElementById('listaComandas');
        lista.innerHTML = '';
        comandas.filter(c => c.status === abaAtual).forEach((c) => {
            const realIndex = comandas.indexOf(c);
            lista.innerHTML += `
                <div class="comanda-item" onclick="abrirFicha(${realIndex})">
                    <div><b>${c.nome}</b><br><small style="color:#8e8e93">${c.status === 'aberto' ? c.abertura : 'Pago via ' + c.metodo}</small></div>
                    <div style="font-weight:bold; color:${c.status === 'aberto' ? 'var(--blue)' : 'var(--green)'}">R$ ${c.total.toFixed(2)}</div>
                </div>`;
        });
    }

    function fecharModal() { document.getElementById('modalFicha').style.display = 'none'; }
    renderLista();
</script>
</body>
</html>
